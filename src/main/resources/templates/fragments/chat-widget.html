<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="chat-widget">
<div id="vnpay-chat-root">
    <div id="vnpay-chat-btn" aria-label="Mở trợ lý chat">
        <i class="fas fa-comments"></i>
    </div>
    <div id="vnpay-chat-panel" class="vnpay-chat-hidden">
        <div class="vnpay-chat-header">
            <span><i class="fas fa-robot me-2"></i>Trợ lý CTT VNPAY</span>
            <button type="button" id="vnpay-chat-close" aria-label="Đóng"><i class="fas fa-times"></i></button>
        </div>
        <div id="vnpay-chat-messages"></div>
        <div class="vnpay-chat-input-wrap">
            <input type="text" id="vnpay-chat-input" placeholder="Nhập câu hỏi..." maxlength="500" autocomplete="off">
            <button type="button" id="vnpay-chat-send" aria-label="Gửi"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>
<style>
    #vnpay-chat-root { position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-family: 'Be Vietnam Pro', -apple-system, sans-serif; }
    #vnpay-chat-btn {
        width: 56px; height: 56px; border-radius: 50%;
        background: linear-gradient(135deg, #0066cc 0%, #004c99 100%);
        color: #fff; display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 4px 14px rgba(0,102,204,0.4);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    #vnpay-chat-btn:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,102,204,0.5); }
    #vnpay-chat-btn i { font-size: 1.4rem; }
    #vnpay-chat-panel {
        position: absolute; bottom: 70px; right: 0;
        width: 360px; max-width: calc(100vw - 40px); height: 420px;
        background: #fff; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden;
        transition: opacity 0.2s, transform 0.2s;
    }
    #vnpay-chat-panel.vnpay-chat-hidden { opacity: 0; visibility: hidden; transform: translateY(10px); pointer-events: none; }
    #vnpay-chat-panel:not(.vnpay-chat-hidden) { opacity: 1; visibility: visible; transform: translateY(0); }
    .vnpay-chat-header {
        padding: 12px 16px; background: linear-gradient(135deg, #0066cc 0%, #004c99 100%);
        color: #fff; font-weight: 700; display: flex; align-items: center; justify-content: space-between;
    }
    .vnpay-chat-header button { background: none; border: none; color: #fff; cursor: pointer; padding: 4px; }
    .vnpay-chat-header button:hover { opacity: 0.9; }
    #vnpay-chat-messages {
        flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px;
        background: #f8fafc;
    }
    .vnpay-msg { max-width: 85%; padding: 10px 12px; border-radius: 12px; font-size: 0.9rem; line-height: 1.45; white-space: pre-wrap; word-break: break-word; }
    .vnpay-msg.bot { align-self: flex-start; background: #fff; border: 1px solid #e2e8f0; color: #0f172a; }
    .vnpay-msg.user { align-self: flex-end; background: #0066cc; color: #fff; }
    .vnpay-msg strong { font-weight: 700; }
    .vnpay-chat-input-wrap { padding: 10px; border-top: 1px solid #e2e8f0; display: flex; gap: 8px; background: #fff; }
    #vnpay-chat-input { flex: 1; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px 12px; font-size: 0.9rem; }
    #vnpay-chat-input:focus { outline: none; border-color: #0066cc; box-shadow: 0 0 0 2px rgba(0,102,204,0.2); }
    #vnpay-chat-send { width: 42px; height: 42px; border-radius: 10px; border: none; background: #0066cc; color: #fff; cursor: pointer; }
    #vnpay-chat-send:hover { background: #004c99; }
    #vnpay-chat-send:disabled { opacity: 0.6; cursor: not-allowed; }
</style>
<script th:inline="javascript">
    (function() {
        var chatApiUrl = /*[[@{/api/chat}]]*/ '/api/chat';
        var btn = document.getElementById('vnpay-chat-btn');
        var panel = document.getElementById('vnpay-chat-panel');
        var closeBtn = document.getElementById('vnpay-chat-close');
        var messagesEl = document.getElementById('vnpay-chat-messages');
        var inputEl = document.getElementById('vnpay-chat-input');
        var sendBtn = document.getElementById('vnpay-chat-send');

        function showPanel() { panel.classList.remove('vnpay-chat-hidden'); }
        function hidePanel() { panel.classList.add('vnpay-chat-hidden'); }
        function togglePanel() { panel.classList.toggle('vnpay-chat-hidden'); }

        btn.addEventListener('click', togglePanel);
        closeBtn.addEventListener('click', hidePanel);

        function escapeHtml(s) {
            var d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }
        function formatReply(text) {
            return escapeHtml(text).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }

        function addMessage(text, isUser) {
            var div = document.createElement('div');
            div.className = 'vnpay-msg ' + (isUser ? 'user' : 'bot');
            if (isUser) div.textContent = text;
            else div.innerHTML = formatReply(text);
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function setLoading(loading) {
            sendBtn.disabled = loading;
        }

        var chatHistory = [];
        var maxHistoryMessages = 10;

        function buildHistoryForApi() {
            var len = chatHistory.length;
            var start = Math.max(0, len - maxHistoryMessages);
            return chatHistory.slice(start).map(function(m) { return { role: m.role, content: m.content }; });
        }

        function sendMessage() {
            var msg = (inputEl.value || '').trim();
            if (!msg) return;
            inputEl.value = '';
            addMessage(msg, true);
            chatHistory.push({ role: 'user', content: msg });
            setLoading(true);
            var payload = { message: msg, history: buildHistoryForApi().slice(0, -1) };
            fetch(chatApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var reply = data.reply || 'Không có phản hồi.';
                addMessage(reply, false);
                chatHistory.push({ role: 'assistant', content: reply });
            })
            .catch(function() {
                addMessage('Đã xảy ra lỗi. Vui lòng thử lại.', false);
                chatHistory.push({ role: 'assistant', content: 'Đã xảy ra lỗi. Vui lòng thử lại.' });
            })
            .finally(function() { setLoading(false); });
        }

        sendBtn.addEventListener('click', sendMessage);
        inputEl.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });

        if (messagesEl.children.length === 0) {
            var welcome = 'Chào bạn! Tôi là trợ lý CTT VNPAY. Bạn có thể hỏi về checksum, return URL, hoàn tiền, truy vấn giao dịch, encode URL... Gõ **menu** để xem gợi ý. (Nếu đã cấu hình Gemini/OpenAI và tài liệu VNPAY, tôi sẽ trả lời dựa trên tài liệu.)';
            addMessage(welcome, false);
        }
    })();
</script>
</div>
</body>
</html>
